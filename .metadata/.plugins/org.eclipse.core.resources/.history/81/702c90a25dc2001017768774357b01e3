/**
 * main.c
 *
 * This is the main application for the bare-metal 6502 emulator
 * on the STM32C0 (Nucleo-C071RB).
 *
 * It initializes all bare-metal drivers (SysTick, GPIO, UART),
 * then initializes the emulator modules (Bus, CPU, GUI).
 *
 * It runs the 1MHz "cycle budget" loop.
 *
 * FIX: This version re-adds the SystemClock_Config() to
 * force the chip to run at 48MHz, fixing the UART baud rate.
 */

#include <stdint.h>
#include "stm32c0xx.h" // Needed for clock config registers

// Bare-Metal Drivers
#include "systick.h"
#include "gpio.h"
#include "uart.h"

// Emulator Core
#include "bus.h"
#include "cpu.h"
#include "gui.h"

// --- Clock & Speed Configuration ---
#define HSI_CLOCK_FREQ 48000000UL

// --- Emulator Speed Configuration ---
#define TARGET_CYCLES_PER_SECOND 1000000  // 1.0 MHz
#define CYCLES_PER_MILLISECOND (TARGET_CYCLES_PER_SECOND / 1000)

// Global state for our virtual CPU
cpu_t cpu;


/**
 * @brief Configures the system clock to run at 48MHz from HSI48.
 * THIS IS THE FIX.
 */
static void SystemClock_Config(void)
{
    // 1. Enable HSI48 oscillator
    RCC->CR |= RCC_CR_HSION;

    // 2. Wait until HSI48 is ready
    while (!(RCC->CR & RCC_IT_HSI48RDY)) {
        // Wait
    }

    // 3. Set HSI48 as the system clock source
    RCC->CFGR &= ~RCC_CFGR_SW_Msk; // Clear SW bits
    RCC->CFGR |= RCC_CFGR_SWS_HSI48; // Select HSI48

    // 4. Wait until HSI48 is in use
    while ((RCC->CFGR & RCC_CFGR_SWS_Msk) != RCC_CFGR_SWS_HSI48) {
        // Wait
    }
}


int main(void)
{
    // --- 0. SET THE SYSTEM CLOCK! ---
    // This MUST be the very first thing you do.
    SystemClock_Config();

    // --- 1. Init Hardware Drivers (Layer 0) ---
    // Now we can safely pass the 48MHz clock speed to the drivers
    systick_init(HSI_CLOCK_FREQ);
    led_init();
    uart_init(); // UART baud rate will now be correct

    // --- 2. Init Emulator Modules (Layers 1-3) ---
    bus_init();         // Clears the 6502's RAM
    cpu_reset(&cpu);    // Resets the CPU (loads PC from $FFFC)
    term_init();        // Clears the terminal screen

    // --- 3. Setup Main Loop Timers ---
    uint32_t last_time_ms = systick_get_ms();
    uint64_t cycle_budget = 0;
    uint32_t last_gui_update_ms = last_time_ms;

    // --- 4. Run Main Loop ---
    while (1)
    {
        // --- A. Add to Cycle Budget (The "Paycheck") ---
        uint32_t current_time_ms = systick_get_ms();
        uint32_t elapsed_ms = current_time_ms - last_time_ms;

        if (elapsed_ms > 0) {
            cycle_budget += (CYCLES_PER_MILLISECOND * elapsed_ms);
            last_time_ms = current_time_ms;
        }

        // --- B. Run the CPU (Spend Budget) ---
        if (cycle_budget > 0)
        {
            uint64_t cycles_before = cpu.cycles;
            cpu_step(&cpu); // Run one instruction
            uint64_t cycles_ran = cpu.cycles - cycles_before;

            if (cycles_ran <= cycle_budget)
                cycle_budget -= cycles_ran;
            else
                cycle_budget = 0; // Overspent
        }

        // --- C. Update Terminal GUI (10x per second) ---
        if (current_time_ms - last_gui_update_ms > 100) // 100ms = 10Hz
        {
            term_update_dashboard(&cpu);
            last_gui_update_ms = current_time_ms;
        }
    }
}
