/**
 * main.c
 *
 * This is a simple test program to verify that the
 * bare-metal UART and SysTick drivers are working.
 *
 * It will print a "HEARTBEAT" message to the terminal
 * once per second.
 *
 * FIX: This version now includes a SystemClock_Config()
 * to FORCE the clock to 16MHz, which will
 * guarantee the baud rate is correct.
 */

// Bare-Metal Drivers
#include "systick.h"
#include "uart.h"
#include <stdint.h>
#include "stm32c0xx.h" // Needed for clock registers

// --- Clock Configuration ---
// We will FORCE the clock to 16MHz
#define SYS_CLOCK_FREQ 16000000UL

/**
 * @brief Configures the system clock to 16MHz using HSI.
 * This is the new, correct approach.
 */
static void SystemClock_Config(void)
{
    // 1) Enable HSI16
    RCC->CR |= RCC_CR_HSION;
    while ((RCC->CR & RCC_CR_HSIRDY) == 0) { }

    // 2) Make sure prescalers are /1
    RCC->CFGR &= ~(RCC_CFGR_HPRE_Msk | RCC_CFGR_PPRE_Msk);  // HPRE=/1, PPRE=/1

    // 3) Select HSI as SYSCLK source
    // For STM32C0: SW bits are bits [1:0] in RCC->CFGR
    // 00 = HSI, 01 = HSE, 10 = PLL
    RCC->CFGR = (RCC->CFGR & ~RCC_CFGR_SW_Msk) | (0x0U << RCC_CFGR_SW_Pos);  // 0x0 = HSI

    // 4) Wait until the switch is done
    while ((RCC->CFGR & RCC_CFGR_SWS_Msk) != (0x0U << RCC_CFGR_SWS_Pos)) { }

    // 5) Set global variable
    SystemCoreClock = 16000000UL;
}


/**
 * @brief A simple blocking delay function.
 * @param ms Milliseconds to wait.
 */
void delay_ms(uint32_t ms)
{
    uint32_t start_time = systick_get_ms();
    while ((systick_get_ms() - start_time) < ms)
    {
        // Wait
    }
}


int main(void)
{
    // --- 0. SET THE SYSTEM CLOCK! ---
    // This MUST be the very first thing you do.
    SystemClock_Config();

    // --- 1. Init Hardware Drivers (Layer 0) ---
    // Now we pass the GUARANTEED 16MHz clock speed
    systick_init(SYS_CLOCK_FREQ);
    uart_init(SYS_CLOCK_FREQ); // UART baud rate will now be correct

    // --- 2. Send a startup message ---
    uart_write_string("\r\n--- UART DRIVER TEST ---\r\n");
    uart_write_string("CLOCK FORCED: 16 MHz\r\n");
    uart_write_string("If you see this, your UART is working!\r\n");

    // --- 3. Run the main "heartbeat" loop ---
    while (1)
    {
        // Print a message
        uart_write_string("HEARTBEAT - OK\r\n");

        // Wait for 1 second
        delay_ms(1000);
    }
}
