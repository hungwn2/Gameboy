/**
 * main.c
 *
 * This is the main application for the bare-metal 6502 emulator
 * on the STM32C0 (Nucleo-C071RB).
 *
 * It initializes all bare-metal drivers (SysTick, GPIO, UART),
 * then initializes the emulator modules (Bus, CPU, GUI).
 *
 * It runs the 1MHz "cycle budget" loop.
 *
 * FIX: This version has the 100% CORRECT SystemClock_Config
 * for the STM32C0 to run at 16MHz using HSI16.
 * The previous PLL/HSI48 code was for the wrong chip.
 */

#include <stdint.h>
#include "stm32c0xx.h" // Needed for clock config registers

// Bare-Metal Drivers
#include "systick.h"
#include "gpio.h"
#include "uart.h"

// Emulator Core
#include "bus.h"
#include "cpu.h"
#include "terminal_gui.h"

// --- Clock & Speed Configuration ---
// FIX: The STM32C0's clock is 16MHz (HSI16)
#define SYS_CLOCK_FREQ 16000000UL // We are setting it to 16MHz

// --- Emulator Speed Configuration ---
#define TARGET_CYCLES_PER_SECOND 1000000  // 1.0 MHz
#define CYCLES_PER_MILLISECOND (TARGET_CYCLES_PER_SECOND / 1000)

// Global state for our virtual CPU
cpu_t cpu;


/**
 * @brief Configures the system clock to run at 16MHz.
 * This is the CORRECT version for the STM32C0.
 * It uses the HSI16 (16MHz) oscillator.
 */
static void SystemClock_Config(void)
{
    // 1. Enable HSI16 oscillator
    // This is the 'RCC_CR_HSION' you saw in the error message!
    RCC->CR |= RCC_CR_HSION;

    // 2. Wait until HSI16 is ready
    while (!(RCC->CR & RCC_CR_HSIRDY)) {
        // Wait
    }

    // 3. Set HSI16 as the system clock source
    RCC->CFGR &= ~RCC_CFGR_SW_Msk; // Clear SW bits
    RCC->CFGR |= RCC_CFGR_SW_HSI;  // Select HSI16 as SYSCLK

    // 4. Wait until HSI16 is in use
    while ((RCC->CFGR & RCC_CFGR_SWS_Msk) != RCC_CFGR_SWS_HSI) {
        // Wait
    }

    // (System is now running at 16MHz)
}


int main(void)
{
    // --- 0. SET THE SYSTEM CLOCK! ---
    // This MUST be the very first thing you do.
    SystemClock_Config();

    // --- 1. Init Hardware Drivers (Layer 0) ---
    // Now we pass the CORRECT 16MHz clock speed to the drivers
    systick_init(SYS_CLOCK_FREQ);
    gpio_output_init();
    uart_init(SYS_CLOCK_FREQ); // UART baud rate will now be correct

    // --- 2. Init Emulator Modules (Layers 1-3) ---
    bus_init();
    cpu_reset(&cpu);    // Resets the CPU (loads PC from $FFFC)
    term_init();        // Initializes the terminal

    // --- 3. Setup Main Loop Timers ---
    uint32_t last_time_ms = systick_get_ms();
    uint64_t cycle_budget = 0;
    uint32_t last_gui_update_ms = last_time_ms;

    // --- 4. Run Main Loop ---
    while (1)
    {
        // --- A. Add to Cycle Budget (The "Paycheck") ---
        uint32_t current_time_ms = systick_get_ms();
        uint32_t elapsed_ms = current_time_ms - last_time_ms;

        if (elapsed_ms > 0) {
            cycle_budget += (CYCLES_PER_MILLISECOND * elapsed_ms);
            last_time_ms = current_time_ms;
        }

        // --- B. Run the CPU (Spend Budget) ---
        if (cycle_budget > 0)
        {
            uint64_t cycles_before = cpu.cycles;
            cpu_step(&cpu); // Run one instruction
            uint64_t cycles_ran = cpu.cycles - cycles_before;

            if (cycles_ran <= cycle_budget)
                cycle_budget -= cycles_ran;
            else
                cycle_budget = 0; // Overspent
        }

        // --- C. Update Terminal GUI (10x per second) ---
        if (current_time_ms - last_gui_update_ms > 100) // 100ms = 10Hz
        {
            term_update_dashboard(&cpu);
            last_gui_update_ms = current_time_ms;
        }
    }
}
